<% content_for :turbo_frame_content do %>
  <%= turbo_frame_tag :drawer, data: { controller: 'drawer', action: 'turbo:before-frame-render->drawer#animate' } %>
<% end %>

<section>
  <div class="mx-auto max-w-7xl 2xl:px-0">
    <div class="gap-4 sm:flex sm:items-center sm:justify-between">
      <h2 class="text-xl font-semibold text-black sm:text-2xl"><%= t('.title') %></h2>
    </div>

    <div class="mt-6 flow-root">
      <div class="grid gap-4">
        <% @orders.each do |order| %>
          <div
            data-controller="toggle"
            class="
              rounded-lg border border-primary-200 bg-white shadow-sm transition-all duration-200
              hover:border-primary-400
            "
            data-toggle-expanded-class="border-primary-700 shadow-md"
          >
            <!-- Order Header -->
            <div class="p-4 flex justify-between gap-3 items-start border-b border-primary-100">
              <div class="flex items-start gap-4 flex-1 min-w-0">
                <div class="flex-1 min-w-0">
                  <p class="text-xs font-medium text-primary-600"><%= t('.order_id') %></p>

                  <div class="flex items-center gap-2 mt-0.5">
                    <!-- Mobile: Show abbreviated ID -->
                    <p class="sm:hidden text-sm font-semibold text-primary-700 font-mono">
                      <%= order.id.first(22) %>...
                    </p>

                    <!-- Desktop: Show full truncated ID -->
                    <p class="hidden sm:block text-sm font-semibold text-primary-700 font-mono truncate">
                      <%= order.id %>
                    </p>

                    <button
                      type="button"
                      data-controller="copy"
                      data-copy-text-value="<%= order.id %>"
                      data-action="click->copy#copy"
                      class="
                        shrink-0 p-2.5 sm:p-1.5 text-primary-600 hover:text-primary-800 hover:bg-primary-50 rounded
                        transition-colors touch-manipulation
                      "
                      title="<%= t('.copy_order_id') %>"
                    >
                      <!-- Copy icon -->
                      <svg
                        data-copy-target="copyIcon"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                        />
                      </svg>

                      <!-- Check icon (hidden initially) -->
                      <svg
                        data-copy-target="checkIcon"
                        class="h-4 w-4 hidden"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M5 13l4 4L19 7"
                        />
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="shrink-0">
                  <p class="text-xs font-medium text-primary-600"><%= t('.date') %></p>

                  <p class="text-sm font-semibold text-primary-700 mt-0.5">
                    <%= l(order.created_at, format: :short_with_year) %>
                  </p>
                </div>
              </div>

              <!-- Expand/Collapse Button -->
              <div class="relative group shrink-0">
                <button
                  type="button"
                  data-action="click->toggle#toggle"
                  data-toggle-target="toggleButton"
                  class="
                    p-2 rounded-lg text-primary-600 hover:bg-primary-50 hover:text-primary-800 transition-all
                    duration-200
                  "
                  aria-label="Toggle order details"
                >
                  <svg
                    data-toggle-target="icon"
                    class="h-5 w-5 transition-transform duration-200"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>

                <!-- Tooltip -->
                <div
                  data-toggle-target="buttonTooltip"
                  class="absolute right-0 bottom-full mb-2 hidden group-hover:block z-10 pointer-events-none"
                >
                  <div class="bg-gray-900 text-white text-xs rounded py-1.5 px-3 whitespace-nowrap">
                    <span
                      data-toggle-target="buttonTooltipText"
                      data-toggle-collapsed-text="<%= t('.actions.click_to_expand') %>"
                      data-toggle-expanded-text="<%= t('.actions.click_to_collapse') %>"
                    >
                      <%= t('.actions.click_to_expand') %>
                    </span>

                    <!-- Tooltip arrow -->
                    <div
                      class="
                        absolute right-3 top-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent
                        border-t-gray-900
                      "
                    ></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Summary (Always Visible) -->
            <div class="p-4 flex flex-col lg:flex-row lg:items-start gap-6">
              <!-- Customer Section -->
              <div class="flex-1 min-w-0 space-y-1">
                <div class="flex items-center gap-2 flex-wrap">
                  <p class="text-xs font-medium text-primary-600"><%= t('.customer') %></p>

                  <% if order.requires_invoice %>
                    <span
                      class="
                        inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium
                        text-green-700
                      "
                    >
                      <svg
                        class="h-3 w-3 shrink-0"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>

                      <span><%= t('.requires_invoice') %></span>
                    </span>
                  <% else %>
                    <span
                      class="
                        inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium
                        text-gray-600
                      "
                    >
                      <svg
                        class="h-3 w-3 shrink-0"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>

                      <span><%= t('.not_require_invoice') %></span>
                    </span>
                  <% end %>
                </div>

                <p class="text-sm font-semibold text-black truncate"><%= order.user_email %></p>
              </div>

              <!-- Shipping Section -->
              <div class="flex-1 lg:flex-[1.5]">
                <p class="text-xs font-medium text-primary-600 mb-2"><%= t('.shipping') %></p>

                <div class="flex flex-wrap items-start gap-x-6 gap-y-2">
                  <!-- Total -->
                  <div class="group relative" data-toggle-target="tooltipWrapper">
                    <p class="text-xs font-medium text-gray-600 flex items-center gap-1">
                      <%= t('.total') %>

                      <svg
                        data-toggle-target="tooltipIcon"
                        class="h-3 w-3 text-primary-400 hover:text-primary-600 cursor-help"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                    </p>

                    <p class="text-sm font-bold text-magenta-500"><%= number_to_currency(order.total) %></p>

                    <!-- Tooltip with breakdown -->
                    <div
                      data-toggle-target="tooltipContent"
                      class="
                        absolute left-0 bottom-full mb-2 hidden group-hover:block z-10 w-48 p-3 bg-white rounded-lg
                        shadow-lg border border-primary-200
                      "
                    >
                      <div class="space-y-2 text-xs">
                        <div class="flex justify-between items-center">
                          <span class="text-primary-600"><%= t('.subtotal') %></span>
                          <span class="font-medium text-black"><%= number_to_currency(order.subtotal) %></span>
                        </div>

                        <div class="flex justify-between items-center">
                          <span class="text-primary-600 flex items-center gap-1">
                            <svg
                              class="h-3 w-3"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke="currentColor"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
                              />
                            </svg>

                            <%= t('.label_price') %>
                          </span>

                          <span class="font-medium text-black"><%= number_to_currency(order.label_price) %></span>
                        </div>

                        <div class="border-t border-primary-200 pt-2 flex justify-between items-center">
                          <span class="font-semibold text-black"><%= t('.total') %></span>
                          <span class="font-bold text-magenta-500"><%= number_to_currency(order.total) %></span>
                        </div>
                      </div>

                      <div
                        class="
                          absolute left-4 top-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent
                          border-t-white
                        "
                        style="filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1));"
                      ></div>
                    </div>
                  </div>

                  <!-- Carrier -->
                  <div>
                    <% if order.payment_status_paid? || order.carrier_name %>
                      <%= link_to edit_backoffice_order_path(order), class: 'hover:underline active:underline flex items-center gap-1 w-fit', data: { turbo_frame: :drawer } do %>
                        <p class="text-xs font-medium text-gray-600"><%= t('.carrier_name') %></p>

                        <svg
                          class="w-4 h-4 text-primary-600 hover:text-primary-800"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"
                          />
                        </svg>
                      <% end %>
                      <p class="text-sm font-semibold text-black"><%= order.carrier_name %></p>
                    <% else %>
                      <p class="text-xs font-medium text-gray-600"><%= t('.carrier_name') %></p>
                      <p class="text-sm text-gray-400">-</p>
                    <% end %>
                  </div>

                  <!-- Tracking Number -->
                  <div class="flex-1 min-w-0">
                    <% if order.payment_status_paid? || order.tracking_number %>
                      <%= link_to edit_backoffice_order_path(order), class: 'hover:underline active:underline flex items-center gap-1 w-fit', data: { turbo_frame: :drawer } do %>
                        <p class="text-xs font-medium text-gray-600"><%= t('.tracking_number') %></p>

                        <svg
                          class="w-4 h-4 text-primary-600 hover:text-primary-800"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"
                          />
                        </svg>
                      <% end %>
                      <p class="text-sm font-semibold text-black truncate"><%= order.tracking_number %></p>
                    <% else %>
                      <p class="text-xs font-medium text-gray-600"><%= t('.tracking_number') %></p>
                      <p class="text-sm text-gray-400">-</p>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Status & Actions Footer -->
            <div class="px-4 pb-4 flex flex-wrap items-center justify-between gap-3 border-t border-primary-100 pt-4">
              <!-- Status Badges -->
              <div class="flex flex-wrap items-center gap-3">
                <!-- Workflow Status -->
                <div class="flex items-center gap-2">
                  <span class="text-xs font-medium text-gray-600"><%= t('.workflow') %>:</span>

                  <span
                    class="
                      text-xs inline-flex items-center gap-1.5 rounded-full bg-primary-100 px-2.5 py-1 font-medium
                      text-primary-700
                    "
                  >
                    <svg
                      class="h-3.5 w-3.5 shrink-0"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                      />
                    </svg>

                    <span><%= order.class.human_attribute_name("workflow_status.#{order.workflow_status}") %></span>
                  </span>
                </div>

                <!-- Payment Status -->
                <div class="flex items-center gap-2">
                  <span class="text-xs font-medium text-gray-600"><%= t('.payment') %>:</span>

                  <span
                    class="
                      text-xs inline-flex items-center gap-1.5 rounded-full bg-primary-100 px-2.5 py-1 font-medium
                      text-primary-700
                    "
                  >
                    <svg
                      class="h-3.5 w-3.5 shrink-0"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                      />
                    </svg>

                    <span><%= order.class.human_attribute_name("payment_status.#{order.payment_status}") %></span>
                  </span>
                </div>
              </div>

              <!-- Email Action Button -->
              <% if order.for_in_transit_email? %>
                <div class="shrink-0">
                  <% if order.in_transit_email_sent_at.present? %>
                    <div class="flex flex-col gap-1.5">
                      <%= button_to send_in_transit_email_backoffice_order_path(order), class: 'inline-flex items-center gap-1.5 rounded-md bg-gray-600 px-3 py-2 text-xs font-semibold text-white shadow-sm hover:bg-gray-700 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-gray-600 transition-colors' do %>
                        <svg
                          class="h-4 w-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                          />
                        </svg>

                        <%= t('.resend_in_transit_email') %>
                      <% end %>

                      <span class="text-xs text-gray-500 text-right">
                        <%= t('.email_sent_at', date: l(order.in_transit_email_sent_at, format: :short)) %>
                      </span>
                    </div>
                  <% else %>
                    <%= button_to send_in_transit_email_backoffice_order_path(order), class: 'inline-flex items-center gap-1.5 rounded-md bg-primary-600 px-3 py-2 text-xs font-semibold text-white shadow-sm hover:bg-primary-700 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-green-600 transition-colors' do %>
                      <svg
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                        />
                      </svg>

                      <%= t('.send_in_transit_email') %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>

            <!-- Expandable Details Section -->
            <div data-toggle-target="content" class="hidden border-t border-primary-200 overflow-hidden">
              <div class="p-3 sm:p-4 space-y-4 sm:space-y-6">
                <!-- Delivery Address -->
                <div class="space-y-2 sm:space-y-3">
                  <h3 class="text-sm sm:text-base font-semibold text-black flex items-center gap-2">
                    <svg
                      class="h-4 w-4 text-primary-600 shrink-0"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                      />

                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>

                    <%= t('.delivery_address') %>
                  </h3>

                  <div class="ml-4 sm:ml-6 pl-3 sm:pl-4 border-l-2 border-primary-200">
                    <p class="text-xs sm:text-sm font-medium text-black wrap-break-words">
                      <%= order.address.full_name %>
                    </p>

                    <p class="text-xs text-primary-600 mt-1 wrap-break-words"><%= order.address.short_summary %></p>
                  </div>
                </div>

                <!-- Products -->
                <div class="space-y-2 sm:space-y-3">
                  <h3 class="text-sm sm:text-base font-semibold text-black flex items-center gap-2">
                    <svg
                      class="h-4 w-4 text-primary-600 shrink-0"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                      />
                    </svg>

                    <%= t('.products_list') %>
                  </h3>

                  <div class="space-y-2 sm:space-y-3">
                    <% order.items.each do |item| %>
                      <div
                        class="
                          flex gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg border border-primary-100
                          hover:border-primary-300 transition-colors
                        "
                      >
                        <!-- Product Image -->
                        <div class="shrink-0 w-12 h-16 sm:w-16 sm:h-20">
                          <%= image_tag(cover_image(item.cover, variant: :small), class: 'w-full h-full object-cover rounded', alt: item.title) %>
                        </div>

                        <!-- Product Details -->
                        <div class="flex-1 min-w-0">
                          <h4 class="text-xs sm:text-sm font-medium text-black line-clamp-2 wrap-break-words">
                            <%= item.title %>
                          </h4>

                          <p class="text-xs text-primary-600 mt-0.5 line-clamp-1 wrap-break-words">
                            <%= item.subtitle %>
                          </p>

                          <div class="flex items-center justify-between mt-1 sm:mt-2 gap-2">
                            <span class="text-xs text-primary-600 shrink-0">
                              <%= t('.quantity') %>
                              <%= item.quantity %>
                            </span>

                            <span class="text-xs sm:text-sm font-semibold text-magenta-500 shrink-0">
                              <%= number_to_currency(item.price * item.quantity) %>
                            </span>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>

                <!-- Order Total Summary -->
                <div class="pt-3 border-t border-primary-200">
                  <div class="space-y-2">
                    <!-- Subtotal -->
                    <div class="flex justify-between items-center">
                      <span class="text-sm text-primary-600"><%= t('.subtotal') %></span>
                      <span class="text-sm font-medium text-black"><%= number_to_currency(order.subtotal) %></span>
                    </div>

                    <!-- Shipping -->
                    <div class="flex justify-between items-center">
                      <span class="text-sm text-primary-600 flex items-center gap-1">
                        <svg
                          class="h-3 w-3"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
                          />
                        </svg>

                        <%= t('.label_price') %>
                      </span>

                      <span class="text-sm font-medium text-black"><%= number_to_currency(order.label_price) %></span>
                    </div>

                    <!-- Divider -->
                    <div class="border-t-2 border-primary-300 pt-2"></div>

                    <!-- Total -->
                    <div class="flex justify-between items-center">
                      <span class="text-base font-bold text-black"><%= t('.total') %></span>
                      <span class="text-lg font-bold text-magenta-500"><%= number_to_currency(order.total) %></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</section>
