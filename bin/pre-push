#!/usr/bin/env bash
set -e

# Track current step for error reporting
CURRENT_STEP=""

# Error handler
handle_error() {
  echo ""
  echo "âŒ FAILED: $CURRENT_STEP"
  echo ""
  echo "ğŸ’¡ Fix the issues above and run 'bin/pre-push' again."
  exit 1
}

# Set trap to catch errors
trap 'handle_error' ERR

echo "ğŸ” Running pre-push checks..."
echo ""

CURRENT_STEP="ERB formatting (herb formatter)"
echo "ğŸ’… 1/9 Formatting ERB files..."
npx @herb-tools/formatter "app/views/**/*.erb"
echo "âœ… ERB formatting completed"
echo ""


CURRENT_STEP="ERB linter (erb_lint --lint-all)"
echo "ğŸ“‹ 2/9 Running ERB linter..."
bundle exec erb_lint --lint-all
echo "âœ… ERB linting passed"
echo ""

CURRENT_STEP="RuboCop (rubocop)"
echo "ğŸ” 3/9 Running RuboCop..."
bundle exec rubocop
echo "âœ… RuboCop passed"
echo ""

CURRENT_STEP="Database consistency checks (database_consistency)"
echo "ğŸ—„ï¸  4/9 Running database consistency checks..."
bundle exec database_consistency
echo "âœ… Database consistency passed"
echo ""

CURRENT_STEP="ERB linting with herb (herb linter)"
echo "ğŸ” 5/9 Linting ERB files with herb..."
npx @herb-tools/linter "app/views/**/*.erb"
echo "âœ… Herb linting passed"
echo ""

CURRENT_STEP="Bundle audit (bundle audit)"
echo "ğŸ”’ 6/9 Running bundle audit..."
bundle audit
echo "âœ… Bundle audit passed"
echo ""

CURRENT_STEP="Brakeman security scan (brakeman)"
echo "ğŸ›¡ï¸  7/9 Running Brakeman security scan..."
bundle exec brakeman
echo "âœ… Brakeman passed"
echo ""

CURRENT_STEP="Importmap audit (bin/importmap audit)"
echo "ğŸ“¦ 8/9 Running importmap audit..."
bin/importmap audit
echo "âœ… Importmap audit passed"
echo ""

CURRENT_STEP="All tests (rails test:all)"
echo "ğŸ§ª 9/9 Running all tests..."
bin/rails test:all
echo "âœ… All tests passed"
echo ""

echo "âœ¨ All pre-push checks passed! Ready to create PR."
